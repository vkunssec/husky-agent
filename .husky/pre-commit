#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "Executando o hook de pre-commit para revisão de código com Gemini..."

# Obtém a lista de arquivos no 'stage' (prontos para commit),
# filtrando por extensões comuns de arquivos de código.
# O '--diff-filter=d' exclui arquivos deletados da lista.
STAGED_FILES=$(git diff --cached --name-only --diff-filter=d | grep -E '\.(js|jsx|ts|tsx|py|go|java|cs|php|rb|rs|html|css|scss|md)$')

if [ -z "$STAGED_FILES" ]; then
  echo "Nenhum arquivo para revisar. Commit procederá normalmente."
  exit 0
fi

echo "Os seguintes arquivos serão revisados:"
echo "$STAGED_FILES"
echo ""

# O comando 'exec < /dev/tty' permite que o Gemini CLI seja interativo, se necessário.
# Em seguida, o comando do Gemini é chamado com os arquivos a serem revisados.
exec < /dev/tty
gemini "Revise as seguintes mudanças no código, focando em qualidade, clareza e aderência a boas práticas. Forneça feedback sobre possíveis bugs, problemas de estilo ou oportunidades de melhoria. Responda em Português." $STAGED_FILES

# Verifica o código de saída do comando Gemini.
# Se for diferente de 0 (indicando um erro ou falha), o commit é abortado.
if [ $? -ne 0 ]; then
  echo "A revisão do Gemini encontrou problemas ou falhou. O commit foi abortado."
  exit 1
fi

echo "Revisão do Gemini concluída com sucesso. Prosseguindo com o commit."
